var editor1=CKEDITOR.replace("notice");var editor2=CKEDITOR.replace("meeting_date");var editor3=CKEDITOR.replace("guest");var editor4=CKEDITOR.replace("meeting_ticket");var start_day={elem:"#start_day",event:"focus",format:"YYYY-MM-DD hh:mm",min:laydate.now(),max:"2099-06-16",istime:true,istoday:false,choose:function(e){$("#start_day").attr("value",e);$("#end_day").attr("value",e);$("#deadline").attr("value",e);end_day.min=e;deadtime.max=e;var t=DateDiff(laydate.now().slice(0,10),e.slice(0,10));if(t<7)swal("请在会议开始前一周提交")}};var end_day={elem:"#end_day",event:"focus",format:"YYYY-MM-DD hh:mm",min:laydate.now(),max:"2099-06-16",istime:true,istoday:false,choose:function(e){$("#end_day").attr("value",e)}};var deadtime={elem:"#deadline",event:"focus",format:"YYYY-MM-DD hh:mm",max:"2099-06-16",istime:true,istoday:false,choose:function(e){$("#deadline").attr("value",e)}};laydate.skin("danlan");laydate(start_day);laydate(end_day);laydate(deadtime);var issave=0;$(".save").click(function(){var e=$("#Fee_name");var t=$("#deadline");var a=$("#price");var i=$("#serve");var n="<tr class='project'>"+" <td>"+e.val()+"</td><td>"+a.val()+"</td><td>"+t.val()+"</td><td style='width: 38%'>"+i.val()+"</td>"+"<td style='width: 10%;padding:10px 0;'><span class='edit' onclick='change(this)'><font class='myfont'>&#xe601;</font>编辑</span><p/><span class='edit' onclick='expurgate(this)'><font class='myfont'>&#xf0002;</font>删除</span></td>"+"</li>";if(e.val()==""){$(e).addClass("not")}else{$(e).removeClass("not")}if(!parseFloat(a.val())||!a.val().match(/^(\.\d+)|^(\d+(\.\d+)?)$/)){$(a).addClass("not")}else{$(a).removeClass("not")}if(i.val()==""){$(i).addClass("not")}else{$(i).removeClass("not")}if(e.val()!=""&&parseFloat(a.val())&&a.val().match(/^(\.\d+)|^(\d+(\.\d+)?)$/)&&i.val()!=""&&issave==0){$(".t_head").show();$(".t_head").after(n);$(e).attr("value","");$(a).attr("value","");$(i).attr("value","")}});$(".cancel").click(function(){if(issave==0){$("#price").attr("value","");$("#serve").attr("value","");$("#price").removeClass("not");$("#serve").removeClass("not");if($(".project").length>0){$(".add_div").slideUp(10)}}});$("#add_price").click(function(){$(".add_div").slideDown(10)});var tr,str;function change(e){$(".add_div").show();if(issave==1){swal("请先保存！");return false}issave=1;$(e).parent().parent().hide();tr=$(e).parent().parent();str=$(tr).children();$("#Fee_name").attr("value",$(str[0]).html());$("#price").attr("value",$(str[1]).html());$("#deadline").attr("value",$(str[2]).html());$("#serve").attr("value",$(str[3]).html());$("#price").removeClass("not");$("#serve").removeClass("not");$(".save").click(function(){if(issave==1){var e=$("#Fee_name").val();var t=$("#deadline").val();var a=$("#price").val();var i=$("#serve").val();if(e!=""&&a.match(/^(\.\d+)|^(\d+(\.\d+)?)$/)&&i!=""){$(tr).show();$(str[0]).html(e);$(str[1]).html(a);$(str[2]).html(t);$(str[3]).html(i);$("#Fee_name").attr("value","");$("#price").attr("value","");$("#serve").attr("value","");issave=0}}});$(".cancel").click(function(){if(issave==1){$(tr).show();$("#Fee_name").attr("value","");$("#price").attr("value","");$("#serve").attr("value","");issave=0}})}function expurgate(e){tr=$(e).parent().parent();$(tr).remove()}$("#fee").focus(function(){$(".ticket").show()});$("#free").focus(function(){$(".ticket").hide()});var cat_id=$("#event_cat").val();tags(cat_id);$("#event_cat").change(function(){tags($(this).val())});var city=$("#province").val();changecity(city);$("#province").change(function(){changecity($(this).val())});function tags(e,t){$.ajax({url:"/get_json_tag_by_cat/"+e+"/",dataType:"text",type:"get",success:function(e){$(".event_tag").html(e);$(".event_cat_tag").each(function(){for(var e in t){if($(this).val()==t[e]){$(this).attr("checked","checked")}}})}})}function changecity(e,t){$.ajax({url:"/show_city_json/"+e+"/",dataType:"text",type:"get",success:function(e){$("#city").html(e);$("#city").val(t)}})}$(".captcha_btn").bind("click",function(){var e,t=60;var a="/send_check_mesage/";var i=$.trim($("#phone").val());if(i!=""&&/^1[3-8]+\d{9}$/.test(i)){$(".captcha_btn").attr({disabled:"disabled"});e=setInterval(function(){$(".captcha_btn").text("重发还有"+t+"秒").attr({disabled:"disabled"});t--;if(t<0){clearInterval(e);$(".captcha_btn").text("重新发送").removeAttr("disabled")}},1e3);var n,c="";n=new Date;c+=n.getFullYear();c+=n.getMonth()+1;c+=n.getDate();c+=n.getHours();c+=n.getMinutes();c+=n.getSeconds();$.get(a,{tel:i,time:c},function(e){})}else{swal("请输入手机号码")}return false});$("#checkcode").blur(function(){var e=$.trim($("#phone").val());var t=$.trim($("#checkcode").val());var a="/verify_tel_captcha/";$.post(a,{mobilphone:e,captcha:t},function(e){var t=jQuery.parseJSON(e).flag;if(t==true){$("#checkcode").attr("data-captcha","true")}else{$("#checkcode").attr("data-captcha","false")}})});$("#title").blur(function(){if($(this).val()!=""){$.ajax({url:"/check_event_name/",data:{name:$("#title").val()},type:"get",dataType:"json",async:"false",success:function(e){if(e.code==1){$(".error").css({width:"auto",top:"30px",left:"155px"}).text("该活动已存在，请无重复提交！").fadeIn(10);$(".arrow").fadeIn(10)}else{var t=["发布会","沙龙","旅游","路演","课程培训","评选会","展览","讲座"];var a=$("#title").val();for(var i in t){var n=t[i].split(",");if($.trim(t)!=""){for(var i=0;i<n.length;i++){if(a.indexOf(n[i])>-1){$(".error").css({width:"300px",top:"14px",left:"139px"}).text("很抱歉，该活动类型不在活动家业务范畴，活动家将一律禁止发布，请谅解。").fadeIn(10);$(".arrow").fadeIn(10)}break}}}}}})}});$("#title").focus(function(){$(".error").hide();$(".arrow").fadeOut(0)});$("#free").focus(function(){$(".proof").css({visibility:"hidden"});$($(".proof")[0]).css({visibility:"visible"});$(".invoice").hide();$($(".invoice")[3]).show()});$("#fee").focus(function(){$(".proof").css({visibility:"visible"});$(".invoice").show()});$("#post").click(function(){var e={};var t=new Array;var a=new Array;var i=new Array;var n=new Array;var c=editor1.document.getBody().getHtml();var r=editor2.document.getBody().getHtml();var s=editor3.document.getBody().getHtml();var l=editor4.document.getBody().getHtml();var o="<p><br></p>";$(".mes").each(function(t){e[$(".mes")[t].id]=$(".mes")[t].value});if($("#fee").attr("checked")=="checked"){$(".project").each(function(e){var a=$($(".project")[e]).children();var i={Fee_name:$(a[0]).html(),price:$(a[1]).html(),serve:$(a[3]).html(),deadline:$(a[2]).html()};t.push(i)});e["ticket_price"]=JSON.stringify(t)}else{e["ticket_price"]="[]"}$(".event_cat_tag").each(function(e){if($($(".event_cat_tag")[e]).attr("checked")=="checked"){a.push($(this).val())}});e["event_tag"]=JSON.stringify(a);$("input[name=pathway]").each(function(){if($(this).attr("checked")=="checked"){e["invoice"]=$(this).val()}});$("input[name=evidence]").each(function(e){if($($("input[name=evidence]")[e]).attr("checked")=="checked"){i.push($(this).val())}});$(".nav-pills li").each(function(e){n.push($($(".nav-pills li")[e]).text())});if($("#charge").attr("checked")=="checked"){$("#charge").attr("value","8")}else{$("#charge").attr("value","0")}e["evidence"]=JSON.stringify(i);e["charge"]=$("#charge").val();e["meeting"]=c;e["schedule"]=r;e["guest"]=s;e["ticket"]=l;e["meeting_title_name"]=JSON.stringify(n);if($("#title").val()==""){swal("请填写会议标题")}else if($("#start_day").val()==""){swal("请填写会议开始时间")}else if($("#address").val()==""){swal("请填写场馆名称")}else if(c==o&&r==o&&s==o&&l==o){swal("请填写会议详情")}else if($("#fee").attr("checked")=="checked"&&$(".project").length==0){swal("请保存票价")}else if($("#name").val()==""){swal("请填写联系人")}else if($("#sponsor").val()==""){swal("请填写主办单位名称")}else if(!$("#phone").val().replace(/[ ]/g,"").match(/0?(13|14|15|18|17)[0-9]{9}/)){swal("请填写正确的手机号码")}else if($("#checkcode").attr("data-captcha")!="true"){swal("验证码错误")}else if(!$("#email").val().match(/\w+((-w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+/)){swal("请填写正确的邮箱地址")}else if(!$("#rule").attr("checked")){swal("请仔细阅读并勾选活动家服务条款")}else if($(this).attr("data-sign")==0){var d=JSON.stringify(e);sessionStorage.obj=d;$("#login").show();$(".close").click(function(){$("#login").hide()})}else{$.ajax({url:"/postevent_act/",type:"post",data:e,dataType:"json",async:false,beforeSend:function(){$("#post").attr("value","正在提交...");$("#post").attr("disabled","disabled")},success:function(e){$("#post").attr("value","提交");$("#post").removeAttr("disabled");if(e.code==-1){swal("很抱歉，提交失败！请联系客服，我们将尽快解决您出现的问题！")}else if(e.code==1){swal("提交成功，我们将在24小时内审核您的会议，因提交的会议太多，请耐心等待，审核后会短信通知您，谢谢。");sessionStorage.obj="";$(".confirm").click(function(){window.location.href="http://www.huodongjia.com/usercenter/index/?ind=myevent"})}}})}});$("#preview").click(function(){var e={};var t=new Array;var a=new Array;var i=new Array;var n=new Array;var c=editor1.document.getBody().getHtml();var r=editor2.document.getBody().getHtml();var s=editor3.document.getBody().getHtml();var l=editor4.document.getBody().getHtml();var o="<p><br></p>";$(".mes").each(function(t){e[$(".mes")[t].id]=$(".mes")[t].value});if($("#fee").attr("checked")=="checked"){$(".project").each(function(e){var a=$($(".project")[e]).children();var i={Fee_name:$(a[0]).html(),price:$(a[1]).html(),serve:$(a[3]).html(),deadline:$(a[2]).html()};t.push(i)});e["ticket_price"]=JSON.stringify(t)}else{e["ticket_price"]="[]"}$(".event_cat_tag").each(function(e){if($($(".event_cat_tag")[e]).attr("checked")=="checked"){a.push($(this).val())}});e["event_tag"]=JSON.stringify(a);$("input[name=pathway]").each(function(t){if($("input[name=pathway]")[t].checked="checked"){e["invoice"]=$(this).val()}});$("input[name=evidence]").each(function(e){if($($("input[name=evidence]")[e]).attr("checked")=="checked"){i.push($(this).val())}});$(".nav-pills li").each(function(e){n.push($($(".nav-pills li")[e]).text())});e["evidence"]=JSON.stringify(i);e["charge"]=$("#charge").attr("checked");e["meeting"]=c;e["schedule"]=r;e["guest"]=s;e["ticket"]=l;e["meeting_title_name"]=JSON.stringify(n);var d=document.createElement("FORM");document.body.appendChild(d);d.method="post";d.target="_blank";for(var v in e){var h=document.createElement("input");h.setAttribute("name",v);h.setAttribute("type","hidden");d.appendChild(h);h.value=e[v]}d.action="/postevent_pre/";d.submit()});function DateDiff(e,t){var a,i,n,c;a=e.split("-");i=new Date(a[0],a[1]-1,a[2]);a=t.split("-");n=new Date(a[0],a[1]-1,a[2]);c=parseInt(Math.abs(i-n)/1e3/60/60/24);return c}window.onload=function(){if(sessionStorage.obj&&$("#post").attr("data-sign")==1){swal("正在提交...");var e=JSON.parse(sessionStorage.obj);$.ajax({url:"/postevent_act/",type:"post",data:e,dataType:"json",async:false,beforeSend:function(){$("#post").attr("value","正在提交...");$("#post").attr("disabled","disabled")},success:function(e){$("#post").attr("value","提交");$("#post").removeAttr("disabled");if(e.code==-1){swal("很抱歉，提交失败！请联系客服，我们将尽快解决您出现的问题！")}else if(e.code==1){swal("提交成功，我们将在24小时内审核您的会议，因提交的会议太多，请耐心等待，审核后会短信通知您，谢谢。");sessionStorage.obj="";$(".confirm").click(function(){window.location.href="http://www.huodongjia.com/usercenter/index/?ind=myevent"})}}})}};